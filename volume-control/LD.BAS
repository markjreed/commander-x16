GOSUB LOADDIR
PRINT DS$,DD
PRINT
FOR I=0 TO DD
   PRINT DList$(I)
Next
PRINT
END




    REM LOAD DISK DIRECTORY INTO BASIC VARIABLES
    REM BEFORE CALLING, SET DEVICE TO DISK DEVICE IF NOT 8
    REM ON RETURN, DD WILL BE THE NUMBER OF ENTRIES IN THE DIRECTORY
    REM DD$(0, 0) WILL BE THE VOLUME/DIRECTORY NAME
    REM DD$(I, 0) WILL BE THE FILENAME FROM ENTRY # I (1 <= I <= DD)
    REM DD$(I, 1) WILL BE THE THREE-LETTER FILE TYPE (PRG, DIR)
    REM DD%(I) WILL BE THE SIZE IN BLOCKS
    REM IF DD IS 0 ON ENTRY, THE ARRAYS WILL BE CREATED BY THE ROUTINE
    REM IF DD IS NONZERO, ARRAYS MUST ALREADY BE ALLOCATED (AND BIG ENOUGH)
    REM
LOADDIR:
     CLOSE 1
     DEVICE = DEVICE - (DEVICE = 0) * 8
     IF DD THEN START.DIR.LOAD
     OPEN 1, DEVICE, 0, "$=D"
     OPEN 15, DEVICE, 15
     INPUT#15, DS, DS$, T, S
     CLOSE 15
     IF DS THEN DD = -1: RETURN
     BINPUT#1, LA$, 2: REM SKIP LOAD ADDRESS
     IF ST AND 64 THEN DS$="UNEXPECTED EOF 1": DD = -1: RETURN
     FOR I = 0 TO -1 STEP 0
       BINPUT#1, LL$, 2: REM SKIP NEXT-LINE POINTER
       IF ST AND 64 THEN DONE.COUNT
       BINPUT#1, SZ$, 2: REM SKIP SIZE
       IF ST AND 64 THEN DS$="UNEXPECTED EOF 2":DD = -1: RETURN
       LINPUT#1, LI$, 0
       DD = DD + 1
       I=( (ST AND 64)<>0 )
     NEXT
     DD=DD-1
DONE.COUNT:
     CLOSE 1
     DIM X
     DIM P
     DIM DList$(DD-1)
     P = POINTER(DList$(0))
     UBOUND = (PEEK(POINTER(DList$(0))-2)*256 + (PEEK(POINTER(DList$(0))-1)))-1
     ## USE IF I NEED FILE SIZE DIM DD%(DD)
     DIM IsBook%(DD):IsBook%(0) = 0
START.DIR.LOAD:
     OPEN 1, DEVICE, 0, "$=D"
     BINPUT#1, LA$, 2: REM SKIP LOAD ADDRESS
     IF ST AND 64 THEN D$ = "UNEXPECTED EOF 3": DD = -1: RETURN
     DD = 0
StartReadingDIR:
     FOR I = 0 TO -1 STEP 0
        BINPUT#1, LL$, 2:REM SKIP NEXT-LINE POINTER
        IF ST AND 64 THEN DONE.DIR.LOAD
        GET#1, L$:L = ASC(L$): REM LOW BYTE OF SIZE
        IF ST AND 64 THEN DS$ = "UNEXPECTED EOF 4": DD = -1: RETURN
        GET#1, H$:H = ASC(H$):REM HIGH BYTE OF SIZE
        IF ST AND 64 THEN DS$ = "UNEXPECTED EOF 5": DD = -1: RETURN
        ## USE IF I NEED FILE SIZE DD%(DD) = FN SW(256*H + L)
        LINPUT#1, X$, 34:REM SKIP TO FIRST QUOTE
        IF ST AND 64 THEN DONE.DIR.LOAD
        LINPUT#1, X$, 34
        IF X$<>"." AND X$<>".." THEN DList$(DD)=X$:GOTO CONT.D.LOAD :REM GET FILE NAME
        LINPUT#1, X$, 0
        GOTO SKIP.OVER.ENTRY
   CONT.D.LOAD:
        DIndx = DD
        IF ST AND 64 THEN DS$ = "UNEXPECTED EOF 7": DD = -1: RETURN
        LINPUT#1, X$, 0:REM GET REST OF LINE
        IF ST AND 64 THEN DS$ = "UNEXPECTED EOF 8": DD = -1: RETURN
        DD = DD + 1
  SKIP.OVER.ENTRY:
      NEXT

DONE.DIR.LOAD:
     IF DD<UBOUND THEN FOR I=DD TO UBOUND:DList$(I)=CHR$(160):NEXT
     CLOSE 1
     DD = DD - 1
     DList$(0) = ".."
     IF InRootDir% THEN DList$(0)=CHR$(160)
     IsBook%(0)=0

Sort.Directory:
 REM X = USR(POINTER(DList$(0)))
 REM FOR DIndx = 1 TO DD
 REM   F$=DList$(DIndx)+"/"+"BOOK.DESC":GOSUB FILEEXISTS
 REM   IsBook%(DIndx) = FE%
 REM NEXT
RETURN
